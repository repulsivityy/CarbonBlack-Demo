################
Investigate
################

# Check if a legitimate app (word), spawns a suspicious program (powershell), with intent on network connectivity
parent_name:winword.exe AND process_name:powershell.exe AND childproc_name:conhost.exe

# Check if Email Clients Opening a Browser, and executing an unlisted/resolving executable on endpoint
((parent_name:thunderbird.exe OR parent_name:outlook.exe) AND (process_name:msedge.exe OR process_name:chrome.exe OR process_name:firefox.exe) AND ((childproc_reputation:NOT_LISTED OR childproc_reputation: RESOLVING) AND (childproc_name:*.exe)))

# Check for browsers executing a PE from an unknown or unsigned file publisher
((process_name:iexplore.exe OR process_name:firefox.exe OR process_name:chrome.exe) AND (filemod_name:*.exe OR filemod_name:*.dll) AND (filemod_publisher_state:FILE_SIGNATURE_STATE_NOT_SIGNED OR filemod_publisher_state:FILE_SIGNATURE_STATE_UNKNOWN))

# Check for suspicious powershell usage (hidden, encrypted, etc)
process_name:powershell.exe AND (process_cmdline:"-Enc" OR process_cmdline:"hidden" OR process_cmdline:"-Exec")

# Check for possible lateral movement with powershell 
process_name:powershell.exe AND process_cmdline:IEX AND netconn_count:[1 TO *] AND netconn_ipv4:192.168.230.0/24

# Check for persistence by modifying registry keys
(regmod_name:HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\*)

# Check for potential data exfiltration by not listed processes
(parent_effective_reputation:Not_Listed OR process_reputation:NOT_Listed) AND (netconn_count:[1 TO *] OR netconn_bytes_sent:[1 TO *])

# Check for potential memory injections from powershell or notepad
(parent_name:powershell.exe AND process_name:notepad.exe AND (ttp:MODIFY_PROCESS OR ttp:MODIFY_MEMORY_PROTECTION))


XDR Module: 

# Check for potential beacon-like behaviour
process_effective_reputation:NOT_LISTED AND netconn_request_method:POST AND netconn_count:[10 TO *] 


################
Live Response
################

# Send popup message to terminal
execfg msg * SecOps team needs to take control. Please save all your work now. For more information, please call your IT helpdesk.

# check powershell execution policy
execfg powershell get-executionpolicy

# if persistence seen (from above)
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run

# Upload files / own tools
put c:\users\dominicc1\desktop

# Memory Dump
memdump c:\users\dominicc1\desktop\memdump.dmp

# Download files for further investigations
cd C:\Users\dominicc1\Desktop
execfg powershell compress-archive memdump.dmp machine1_artifects.zip, OR
execfg powershell compress-archive netstat.txt machine1_artifects.zip
get machine1_artifects.zip


################
Live Query
################
# Check Scheduled Tasks
SELECT * FROM scheduled_tasks;

# Check if UAC is disabled
SELECT * FROM registryWHERE path='HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA' AND data=0;
